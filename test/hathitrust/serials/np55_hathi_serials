

WITH parameters AS (
    SELECT
        'serial' ::VARCHAR AS mode_of_issuance_filter, -- 'serial'
        'ISSN' ::VARCHAR AS identifier_filter, -- 'OCLC'
        '' ::VARCHAR AS status_name_filter, -- 'Cataloged'
        '' ::VARCHAR AS identifier_filter -- 'ISSN'
)
SELECT 
    DISTINCT frie.title,
    hol.permanent_location_name,
    frie.instance_hrid,
    --oclcno.oclc_number,
    instind.identifier AS oclc_number,
    frie.mode_of_issuance_name AS instance_mode_of_issuance,
    iht.name AS holdings_type
FROM 
    folio_reporting.instance_ext AS frie
    LEFT JOIN folio_reporting.holdings_ext AS hol ON frie.instance_id = hol.instance_id
    LEFT JOIN folio_reporting.instance_identifiers AS instind ON frie.instance_id = instind.instance_id 
    LEFT JOIN folio_reporting.instance_formats AS if2 ON frie.instance_id = if2.instance_id 
    LEFT JOIN inventory_holdings_types AS iht ON hol.type_id = iht.id 
    LEFT JOIN srs_marctab AS sm ON hol.instance_id = sm.instance_id
WHERE
    (frie.status_name = (SELECT status_name_filter FROM parameters) OR (SELECT status_name_filter FROM parameters) = '')
AND
    (frie.mode_of_issuance_name = (SELECT mode_of_issuance_filter FROM parameters) OR (SELECT mode_of_issuance_filter FROM parameters) = '')
AND 
   (iht.name = 'Serial')
AND (instind.identifier_type_name = 'OCLC')
AND (hol.permanent_location_name NOT in ('serv,remo','Borrow Direct'))
    AND (hol.call_number NOT IN ('%On Order%','%In Process%','%Available for the library to purchase%','%Film%','%fiche%'))
    AND  
    (sm.field = '245' AND sm.sf != 'h');
