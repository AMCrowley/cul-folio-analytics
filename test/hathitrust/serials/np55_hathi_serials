

WITH inst_type AS (SELECT 
    sm.instance_hrid,
    sm.instance_id,
    substring(sm.content, 7, 2) AS "type"
    FROM srs_marctab sm
    WHERE (sm.field = '000' AND substring(sm.content, 7, 2) IN ('as'))
),
title_filtering AS (SELECT
    sm.instance_id AS instance_id
    FROM srs_marctab sm 
    WHERE 
    (sm.field = '245' AND sm.sf != 'h')
),
content_filtering AS (SELECT 
    sm.instance_id AS instance_id
    FROM srs_marctab sm
    WHERE (sm.field = '336' AND sm.sf = 'a' and sm.CONTENT != 'unmediated')
),
mso_filtering AS (SELECT 
    sm.instance_id AS instance_id
    FROM srs_marctab sm
    WHERE sm.field != '945'
),
maps_filtering AS (SELECT 
    sm.instance_id AS instance_id
    FROM srs_marctab sm
    WHERE (sm.field = '300' AND sm.sf = 'a' and sm.CONTENT != 'map%')
),
location_filtering AS (SELECT 
    hol.holdings_hrid AS holdings_hrid,
    hol.instance_id AS instance_id,
    hol.permanent_location_name AS "location"
    FROM folio_reporting.holdings_ext AS hol
    WHERE (hol.permanent_location_name 
    NOT in ('serv,remo','Borrow Direct','LTS Review Shelves'))
),
call_number_filtering AS (SELECT
    hol.instance_id AS instance_id 
    FROM folio_reporting.holdings_ext AS hol
    WHERE hol.call_number 
    NOT IN ('%On Order%','%In Process%','%Available for the library to purchase%','%Film%','%fiche%')   
),
oclc_no AS (
    SELECT
        ii2.instance_id AS instance_id,
        ii2.identifier_type_name AS id_type,
        ii2.identifier AS oclc_number2
    FROM folio_reporting.instance_identifiers AS ii2
    WHERE ii2.identifier_type_name = 'OCLC'
),
gov_doc AS (SELECT
    sm.instance_id AS instance_id,
    CASE 
        WHEN substring(sm.content, 18, 1) IN ('u') 
             AND substring(sm.content, 29, 1) IN ('f') 
             THEN '1'
             ELSE '0' END AS gov_doc
    FROM
    srs_marctab sm
    WHERE
    sm.field = '008'
),
issn_select AS (
 SELECT sm.instance_id AS instance_id,
  sm.field AS field,
  sm.CONTENT AS issn_no
  FROM srs_marctab sm
  WHERE (sm.field = '022' AND sm.sf = 'a' )
)
SELECT 
    DISTINCT frie.title,
    loc_filt."location",
    frie.instance_hrid,
    insttype."type",
    issn_sel.issn_no,
    --iht.name AS holdings_type,
    --frie.mode_of_issuance_name AS mode_type,
      CASE 
        WHEN oclcno.oclc_number2 LIKE '(OCoLC)ocm%' THEN SUBSTRING(oclcno.oclc_number2, 11)
        WHEN oclcno.oclc_number2 LIKE '(OCoLC)ocn%' THEN SUBSTRING(oclcno.oclc_number2, 11)
        WHEN oclcno.oclc_number2 LIKE '(OCoLC)%' THEN SUBSTRING(oclcno.oclc_number2, 8)
        ELSE oclcno.oclc_number2 END AS oclc_no,
    --ii3.identifier AS issn,
    govdoc.gov_doc
FROM 
    folio_reporting.instance_ext AS frie
    left JOIN inst_type AS insttype ON frie.instance_id = insttype.instance_id
    LEFT JOIN title_filtering AS titlefilter ON insttype.instance_id = titlefilter.instance_id
    LEFT JOIN content_filtering AS contentfilter ON titlefilter.instance_id = contentfilter.instance_id
    LEFT JOIN mso_filtering AS msofilter ON contentfilter.instance_id = msofilter.instance_id
    LEFT JOIN maps_filtering AS mapsfilter ON msofilter.instance_id = mapsfilter.instance_id
    LEFT JOIN oclc_no AS oclcno ON mapsfilter.instance_id = oclcno.instance_id
    LEFT JOIN location_filtering AS loc_filt ON oclcno.instance_id = loc_filt.instance_id
    LEFT JOIN call_number_filtering AS call_no_filter ON loc_filt.instance_id = call_no_filter.instance_id
    LEFT JOIN gov_doc AS govdoc ON call_no_filter.instance_id = govdoc.instance_id
    LEFT JOIN issn_select AS issn_sel ON call_no_filter.instance_id = issn_sel.instance_id
    --LEFT JOIN folio_reporting.instance_formats AS if2 ON frie.instance_id = if2.instance_id 
    --LEFT JOIN inventory_holdings_types AS iht ON hol.type_id = iht.id 
    --LEFT JOIN folio_reporting.instance_identifiers AS ii3 ON oclcno.instance_id = ii3.instance_id
--WHERE (iht.name = 'Serial' OR frie.mode_of_issuance_name LIKE 'serial')
--AND (ii3.identifier_type_name = 'ISSN')
--where  CAST(frie.instance_hrid AS INTEGER) BETWEEN '1608800' AND '1608860'
;
